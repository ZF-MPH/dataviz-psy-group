---
title: "proposal_explorations"
author: "Ian, Dillon, Futing"
date: "1/19/2022"
output: html_document
---

```{r InitialSetup}
remotes::install_github("datalorax/edld652")
library(edld652)

set_key("sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2023-01-01T04:52:19Z&st=2021-12-08T20:52:19Z&spr=https&sig=Nmx6zt%2B1iAXDoI5CIgBRoPlsvOPuLlBPvK5uUsldPnw%3D", overwrite = TRUE)
install.packages("usethis")
usethis::edit_r_environ()
list_datasets()

unlink(file.path("~",".Renviron"))
```


```{r}
library(tidyverse)
library(edld652)
library(stringr)
library(here)
library(tidyverse)

datasets <- data.frame(names = edld652::list_datasets())
fiscal_names <- datasets %>% filter(str_detect(names, "CCD_fiscal"))

dis_dat <- get_data("NCES_CCD_nonfiscal_district_2017_2021_disabilities")

#fisc_dat <-  lapply(fiscal_names, get_data) # apparently not all of the fiscal datasets have the same number of variables...
#fisc_dat2 <- do.call(rbind, fisc_2)

raw_fisc_2017 <- get_data("NCES_CCD_fiscal_district_2017") # 2017 should be a good proxy for what we care about
raw_fisc_2018 <- get_data("NCES_CCD_fiscal_district_2018") 
raw_fisc_2018 <- raw_fisc_2018 %>% 
  select(-CE3, -FL_CE3)
fiscal <- rbind(raw_fisc_2017, raw_fisc_2018)


raw_fisc_2018 <- get_data("NCES_CCD_fiscal_district_2018") 
raw_fisc_2018 <- get_data("NCES_CCD_fiscal_district_2018") 

state_info <- readr::read_csv("https://github.com/kjhealy/fips-codes/raw/master/state_fips_master.csv")


acgr_lea <- get_data("EDFacts_acgr_lea_2011_2019")
acgr_sch <- get_data("EDFacts_acgr_sch_2011_2019")
```

# Revenue By State
```{r}

raw_fiscal_17 <- raw_fisc_2017 %>% 
  select(FIPST, LEAID, TOTALREV) %>% 
  mutate(fips = as.numeric(FIPST))


fiscal_sub <- fiscal %>% 
  select(FIPST, LEAID, TOTALREV, sped_rev_st = C05, idea_rev_fed = C15) %>% 
  mutate(fips = as.numeric(FIPST))

state_fiscal_17 <- full_join(raw_fiscal_17, state_info)
state_fiscal <- full_join(fiscal_sub, state_info)



state_fisc_sums <- state_fiscal %>% 
  group_by(state_name) %>% 
  summarize(min_idea_rev_fed = min(idea_rev_fed), 
            max_idea_rev_fed = max(idea_rev_fed), 
            mean_idea_rev_fed = mean(idea_rev_fed), 
            median_idea_rev_fed = median(idea_rev_fed), 
            min_sped_rev_st = min(sped_rev_st), 
            max_sped_rev_st = max(sped_rev_st), 
            mean_sped_rev_st = mean(sped_rev_st), 
            median_sped_rev_st = median(sped_rev_st) 
            ) 



state_fisc_sums %>% 
  ggplot(.,aes(fct_reorder(state_name, mean_rev), mean_rev))+
  geom_col(fill = "cornflowerblue", alpha = .9)+
  coord_flip() +
  labs(
    title = "Revenue by State",
    x = "State", 
    y="Revenue"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(color = "#A9A9A9", size = .6),
        panel.grid.minor.x = element_blank())  ## something appears to be going on with hawaii...
```

# Disabilities by State
```{r}

dis_state_sums <- dis_dat %>% 
  group_by(STATENAME) %>% 
  summarize(idea_tot = sum(IDEA_COUNT, na.rm = TRUE))


dis_state_sums %>% 
  ggplot(.,aes(fct_reorder(STATENAME, idea_tot), idea_tot))+
  geom_col(fill = "cornflowerblue", alpha = .9)+
  coord_flip() +
  labs(
    title = "Students with Disabilities by State",
    x = "State", 
    y="Students with Disabilities"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(color = "#A9A9A9", size = .6),
        panel.grid.minor.x = element_blank())  

```

```{r}
#SpEd spending per student
fiscal_acgr1 <- inner_join(raw_fisc_2017, acgr_lea, by = "LEAID") %>% mutate(SpedPerStudent=C05+C15/CWD_COHORT) %>%  mutate(PerCWD=CWD_COHORT/ALL_COHORT) %>% select(C05, C15, SpedPerStudent, STNAME, CWD_RATE, CWD_COHORT, LEAID, ALL_COHORT, ALL_RATE, PerCWD) %>% filter(LEAID!="1500030")

fiscal_acgr1 <- fiscal_acgr1 %>% mutate(numCWDGradRate=recode(CWD_RATE,
                                        "70-79" = 74.5,
                                        "40-49"= 44.5,
                                        "60-69"= 64.5,
                                        "60-79"= 69.5,
                                        "50-59"= 54.5,
                                        "LE5"= 2.5,
                                        "10-14"= 12,
                                        "60-64"= 62,
                                        "21-39"= 30,
                                        "30-39"= 34.5,
                                        "55-59"= 57,
                                        "LE10"= 5,
                                        "35-39"= 37,
                                        "40-44"= 42,
                                        "40-59"= 49.5,
                                        "50-54"= 52,
                                        "20-24"= 22,
                                        "15-19"= 17,
                                        "6-9"= 7.5,
                                        "11-19"= 15,
                                        "80-89"= 84.5,
                                        "70-74"= 72,
                                        "65-69"= 67,
                                        "75-79"= 77,
                                        "80-84"= 82,
                                        "85-89"= 87,
                                        "45-49"= 47,
                                        "90-94"= 92,
                                        "25-29"= 27,
                                        "GE90"= 95,
                                        "GE95"= 97.5,
                                        "20-29"= 24.5,
                                        "30-34"= 32))

fiscal_acgr1 <- fiscal_acgr1 %>% mutate(numTotalGradRate=recode(ALL_RATE,
                                        "70-79" = 74.5,
                                        "40-49"= 44.5,
                                        "60-69"= 64.5,
                                        "60-79"= 69.5,
                                        "50-59"= 54.5,
                                        "LE5"= 2.5,
                                        "10-14"= 12,
                                        "60-64"= 62,
                                        "21-39"= 30,
                                        "30-39"= 34.5,
                                        "55-59"= 57,
                                        "LE10"= 5,
                                        "35-39"= 37,
                                        "40-44"= 42,
                                        "40-59"= 49.5,
                                        "50-54"= 52,
                                        "20-24"= 22,
                                        "15-19"= 17,
                                        "6-9"= 7.5,
                                        "11-19"= 15,
                                        "80-89"= 84.5,
                                        "70-74"= 72,
                                        "65-69"= 67,
                                        "75-79"= 77,
                                        "80-84"= 82,
                                        "85-89"= 87,
                                        "45-49"= 47,
                                        "90-94"= 92,
                                        "25-29"= 27,
                                        "GE90"= 95,
                                        "GE95"= 97.5,
                                        "20-29"= 24.5,
                                        "30-34"= 32))
#fiscal_acgr1 <- fiscal_acgr1 %>% filter(!is.na(numTotalGradRate))
#fiscal_acgr1 <- fiscal_acgr1 %>% filter(!is.na(numCWDGradRate))
fiscal_acgr1 <- fiscal_acgr1 %>% mutate(CWD_GRAD_COHORT= numCWDGradRate*CWD_COHORT*.01, NONCWD_GRAD_COHORT= (numTotalGradRate*ALL_COHORT*.01)-(numCWDGradRate*CWD_COHORT*.01))

stateLevel <- fiscal_acgr1 %>% group_by(STNAME) %>% summarize(CWD_COHORT=mean(CWD_COHORT, na.rm=TRUE), ALL_COHORT=mean(ALL_COHORT), SpedRev=mean(C05+C15, na.rm=TRUE), NONCWD_GRAD_COHORT=mean(NONCWD_GRAD_COHORT), CWD_GRAD_COHORT=mean(CWD_GRAD_COHORT)) %>% mutate(CWD_RATE=CWD_COHORT/ALL_COHORT) %>% mutate(nonCWD=ALL_COHORT-CWD_COHORT) %>% mutate(SpedPerStudent=SpedRev/CWD_COHORT, CWD_GRAD_RATE = CWD_GRAD_COHORT/CWD_COHORT, NON_CWD_GRAD_RATE=NONCWD_GRAD_COHORT/(ALL_COHORT-CWD_COHORT))


fiscal_acgr2 <-fiscal_acgr1%>% filter(is.numeric(SpedPerStudent))%>% filter(!is.na(SpedPerStudent)) %>% filter(SpedPerStudent>10) %>% group_by(STNAME) %>% summarize(StateSpedPerStudent=mean(SpedPerStudent))



fiscal_acgr2 %>% ggplot(., aes(x=StateSpedPerStudent, y=STNAME)) +
  geom_point(size=2, shape=23)+
  geom_smooth(method=lm, se=FALSE)

fiscal_acgr1 %>% filter(abs(scale(SpedPerStudent))<=1.96) %>% 
ggplot(., aes(x=SpedPerStudent, y=numCWDGradRate-numTotalGradRate)) +
  geom_point(size=2, shape=23)+
  geom_smooth(method=lm, se=FALSE)


```

```{r}
stateLevel2 <- stateLevel %>% pivot_longer(., cols=c("nonCWD","CWD_COHORT"), values_to="count")

 stateLevel2%>% 
   ggplot(.,aes(x=reorder(STNAME, count), y=count, fill = name))+
  geom_col(position = "stack")+
  coord_flip() +
  labs(
    title = "Students with and without Disabilities by State",
    x = "State", 
    y="Students with Disabilities"
  )
 
stateLevel%>% 
   ggplot(.,aes(x=reorder(STNAME,CWD_RATE), y=CWD_RATE))+
  geom_col(position = "stack")+
  coord_flip() +
  labs(
    title = "Students with Disability Rates by State",
    x = "State", 
    y="Percent of Students with Disabilities"
  )

stateLevel%>% 
   ggplot(.,aes(x=reorder(STNAME,CWD_RATE), y=SpedPerStudent))+
  geom_col(position = "stack")+
  coord_flip() +
  labs(
    title = "SpEd Revenue per Student by State",
    x = "States in Order of Disability Rates, Descending", 
    y="Avg Special Ed Revenue per Student"
  )

stateLevel%>% 
   ggplot(.,aes(x=reorder(STNAME,CWD_GRAD_RATE-NON_CWD_GRAD_RATE), y=CWD_GRAD_RATE-NON_CWD_GRAD_RATE))+
  geom_col(position = "stack")+
  coord_flip() +
  labs(
    title = "Differences in CWD/Non-CWD Grad Rates by State",
    x = "State in Order of Disability Rates, Descending", 
    y="Differences in Grad Rates, Disability minus No Disabilties"
  )
```


